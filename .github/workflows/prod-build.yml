name: Prod Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/build.yml@main
    with:
      language: dotnet
      dotnet_version: '8.0.x'

  containerize:
    needs: build
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/containerize.yml@main
    with:
      image_name: strato-api
      platforms: linux/amd64
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  update-gitops:
    needs: containerize
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/manifest-update.yml@main
    with:
      gitops_repo: P7-Chaos-Academy/gitops
      manifest_path: strato-api/deployment.yaml
      image_pattern: 'image: cgamel/strato-api:.*'
      new_image: ${{ needs.containerize.outputs.full_image }}
      commit_message: 'Update strato-api image to ${{ needs.containerize.outputs.image_tag }}'
    secrets:
      GITOPS_REPO_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN }}